/**
 * @file Firebase Security Rules for Prasthan Connect Website
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles
 * and allows public read access for gallery items, team members, and sponsors. Contact form submissions
 * are writeable by anyone, which is suitable for a public contact form.
 *
 * @data_structure
 * - /users/{userId}: Stores user profile data, accessible only to the authenticated user.
 * - /contactFormSubmissions/{contactFormSubmissionId}: Stores contact form submissions.
 * - /galleryItems/{galleryItemId}: Stores publicly accessible gallery items.
 * - /teamMembers/{teamMemberId}: Stores publicly accessible team member information.
 * - /sponsors/{sponsorId}: Stores publicly accessible sponsor information.
 *
 * @key_security_decisions
 * - User data is secured via path-based ownership (`/users/{userId}`), ensuring that only the
 *   authenticated user can access their own data.
 * - Public read access is granted for gallery items, team members, and sponsors to allow for
 *   unauthenticated access to website content.
 * - Contact form submissions are publicly writeable to allow anyone to send a message. Read/update/delete should be restricted to admins.
 * - No user listing is allowed to prevent enumeration of user accounts.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profiles, allowing only the authenticated user to access their own data.
     * @path /users/{userId}
     * @allow (create) - User 'test_user' with ID 'test_user' can create their profile.
     *   `request.auth.uid == 'test_user'` and `request.resource.data.id == 'test_user'`.
     * @allow (update) - User 'test_user' with ID 'test_user' can update their profile.
     *   `request.auth.uid == 'test_user'` and `resource.data.id == 'test_user'`.
     * @allow (get, list) - User 'test_user' with ID 'test_user' can read their profile.
     *   `request.auth.uid == 'test_user'`.
     * @deny (create) - User 'another_user' cannot create a profile with ID 'test_user'.
     *   `request.auth.uid != 'test_user'`.
     * @deny (update) - User 'another_user' cannot update the profile with ID 'test_user'.
     *   `request.auth.uid != 'test_user'`.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isNewOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId) && isOwnerIdImmutable();
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to submit a contact form. Read/update/delete should be restricted.
     * @path /contactFormSubmissions/{contactFormSubmissionId}
     * @allow (create) - Any user can submit the contact form.
     * @principle Allows public submissions. In production, reads should be restricted to admins.
     */
    match /contactFormSubmissions/{contactFormSubmissionId} {
      allow create: if true;
      allow get, list, update, delete: if false; // Should be restricted to admins
    }

    /**
     * @description Allows anyone to read gallery items. Write access should be restricted to admins.
     * @path /galleryItems/{galleryItemId}
     * @allow (get, list) - Any user can read gallery items.
     * @principle Publicly readable data. Write access should be restricted to admins in production.
     */
    match /galleryItems/{galleryItemId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Should be restricted to admins
    }

    /**
     * @description Allows anyone to read team member information. Write access should be restricted to admins.
     * @path /teamMembers/{teamMemberId}
     * @allow (get, list) - Any user can read team member information.
     * @principle Publicly readable data. Write access should be restricted to admins in production.
     */
    match /teamMembers/{teamMemberId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Should be restricted to admins
    }

    /**
     * @description Allows anyone to read sponsor information. Write access should be restricted to admins.
     * @path /sponsors/{sponsorId}
     * @allow (get, list) - Any user can read sponsor information.
     * @principle Publicly readable data. Write access should be restricted to admins in production.
     */
    match /sponsors/{sponsorId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Should be restricted to admins
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isNewOwner(userId) {
    // This check is a bit redundant with isOwnerIdImmutable on create, but good practice.
    return request.auth.uid == userId && request.resource.data.id == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

    function isOwnerIdImmutable() {
    return request.resource.data.id == resource.data.id;
  }
}
